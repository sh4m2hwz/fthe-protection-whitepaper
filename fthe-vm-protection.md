# Виртуализация на основе полного гомоморфного шифрования с использованием открытого ключа с удаленным дешифрованием значений.

 Большинство протекторов таких как VMP, themida, obsidium, enigma уязвимы к атакам по различным каналам данных. Каналы данных - это места в реализации виртуальной машины и в самой ISA VM, где данные не зашифрованы. Инженеры по обратному проектированию совершая атаку на софт накрытым протектором, способны анализировать незашифрованные данные с помощью динамического анализа, как над ними происходят операции, и таким образом реконструировать алгоритм или упрощать его с помощью taint analysis или symbolic execution, таких как Triton DSE, angr,miasm.

Мое решение заключается в виртуализации x86 на основе зашифрованного контекста и байткода, таких как непосредственные значения в инструкциях, память, операции alu над значениями, побитовые и арифметические сдвиги, операции работы с памятью и регистрами. Итак раскрою более детально мою концепцию.

Сама виртуальная машина стековая 128 битная. Ход выполнения виртуальной машины начинается с передачи аргументов, таких как публичный ключ и  зашифрованный байткод. Например: когда интерпретатор выполняет сам байткод и ему попадаются инструкции сохранения значения из памяти в стек вмки, значение шифруется и сохраняется в стек. Если встречаются инструкции восстановления значений из стека в регистр или в память, значения кладутся в зашифрованном виде. Для того чтобы можно было получить в расшифрованном виде значения в памяти или в регистрах x86, понадобиться инструкция vmdecrypt. Суть vmdecrypt заключается в обращении к серверу, который дешифрует значение и отправляет его обратно только уже в незашифрованном ввиде. Все инструкции отвечающие за выталкивание из стека обратно в память или в регистры x86, отслеживаются специальным сборщиком зашифрованных значений, которые в будущем нужно будет расшифровать. Если встречается vmdecrypt, все значения отслеженные сборщиком - расшифровались. По сути ответственность за правильную расшифровку значений лежит на виртуализаторе (компиляторе). 

## ISA

```asm
push imm128 - сохранить зашифрованную imm128 в стек
push mem - извлечь из mem значение 128 битное, зашифровать и сохранить в стек
push reg - извлечь из reg значение 128 битное, зашифровать и сохранить в стек
pop reg - вытолкнуть из стека 128 битное значение и сохранить в регистр
pop mem - вытолкнуть из стека 128 битное значение и сохранить в память
операции 128 битные выполняемые над зашифрованными значениями:
add
sub
mul
div
rem
and
xor
or
shl
shr
ashr
специальные инструкции:
vmexit - выйти из виртуальной машины
vmdecrypt - расшифровать все значения 
```

В заключение, инженер по обратному проектированию может реконструировать байткод с помощью эмуляции или отладки, но не сможет в конкретный момент времени отслеживать значения, которые выполняются в виртуальной машине, так как они зашифрованы. Да, инженер по обратному проектированию сможет реконструировать значения, но только те, которые прилетают от сервера.

telegram contact: @crdivhw


